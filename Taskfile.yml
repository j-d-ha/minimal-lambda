version: '3'

vars:
  NUGET_API: https://api.nuget.org/v3-flatcontainer

tasks:
  validate_version:
    desc: Check that package version does not already exist on NuGet
    silent: true
    cmds:
      - echo "ğŸ“‹ Validating version for {{.DIR}}"
      - bash ./scripts/validate-version.sh '{{.DIR}}'

  clean:
    desc: Clean NuGet packages from Release folder
    silent: true
    cmds:
      - echo "ğŸ§¹ Cleaning"
      - dotnet clean --configuration Release

  pack:
    desc: Build the NuGet package
    silent: true
    cmds:
      - task: clean
      - echo "ğŸ“¦ Packing {{.DIR}}"
      - dotnet restore
      - dotnet build --configuration Release --no-restore
      - dotnet pack --configuration Release --no-build
      - echo "âœ… Packed"

  publish:
    desc: Publish the NuGet package to NuGet.org
    dir: '{{.DIR}}'
    silent: true
    cmds:
      - echo "ğŸš€ Publishing {{.DIR}}"
      - dotnet nuget push bin/Release/*.nupkg --source https://api.nuget.org/v3/index.json --api-key $NUGET_API_KEY --skip-duplicate
      - echo "âœ¨ Published {{.DIR}}"

  lambda-test:
    desc: Start the AWS Lambda test tool
    silent: true
    cmds:
      - dotnet lambda-test-tool start --lambda-emulator-port 5050

  publish-all:
    desc: Pack, validate versions, and publish all packages (Host, Abstractions, OpenTelemetry)
    silent: true
    cmds:
      - echo "ğŸ”„ Starting publish-all workflow"
      # Pack all packages
      - task: pack
      # Validate all versions
      - echo "ğŸ” Validating all versions"
      - task: validate_version
        vars:
          DIR: src/AwsLambda.Host
      - task: validate_version
        vars:
          DIR: src/AwsLambda.Host.Abstractions
      - task: validate_version
        vars:
          DIR: src/AwsLambda.Host.OpenTelemetry
      # Publish all packages
      - echo "ğŸš€ Publishing all packages"
      - task: publish
        vars:
          DIR: src/AwsLambda.Host
      - task: publish
        vars:
          DIR: src/AwsLambda.Host.Abstractions
      - task: publish
        vars:
          DIR: src/AwsLambda.Host.OpenTelemetry
      - echo "âœ¨ All packages published successfully!"