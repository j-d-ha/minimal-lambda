version: '3'

vars:
  NUGET_API: https://api.nuget.org/v3-flatcontainer
  
includes:
  build: BuildTasks.yml

tasks:
  validate_version:
    desc: Check that package version does not already exist on NuGet
    silent: true
    cmds:
      - echo "ğŸ“‹ Validating version for {{.DIR}}"
      - bash ./scripts/validate-version.sh '{{.DIR}}'

  publish:
    desc: Publish the NuGet package to NuGet.org
    dir: '{{.DIR}}'
    silent: true
    cmds:
      - echo "ğŸš€ Publishing {{.DIR}}"
      - dotnet nuget push bin/Release/*.nupkg --source https://api.nuget.org/v3/index.json --api-key $NUGET_API_KEY --skip-duplicate
      - echo "âœ¨ Published {{.DIR}}"

  publish-all:
    desc: Pack, validate versions, and publish all packages (Host, Abstractions, OpenTelemetry)
    silent: true
    cmds:
      - echo "ğŸ”„ Starting publish-all workflow"
      - task: build:pack
      - echo "ğŸ” Validating all versions"
      - task: validate_version
        vars:
          DIR: src/AwsLambda.Host
      - task: validate_version
        vars:
          DIR: src/AwsLambda.Host.Abstractions
      - task: validate_version
        vars:
          DIR: src/AwsLambda.Host.OpenTelemetry
      - echo "ğŸš€ Publishing all packages"
      - task: publish
        vars:
          DIR: src/AwsLambda.Host
      - task: publish
        vars:
          DIR: src/AwsLambda.Host.Abstractions
      - task: publish
        vars:
          DIR: src/AwsLambda.Host.OpenTelemetry
      - echo "âœ¨ All packages published successfully!"
